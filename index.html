// State urutan (sort)
let sortState = {
  column: null, // 'name' atau 'revisi'
  asc: true
};

// --- Ambil Data ---
fetch(url)
  .then(res => res.json())
  .then(json => {
    semuaData = json;
    loadingStatus.textContent = "‚úÖ Siap digunakan";
    loadingStatus.classList.remove("dot-animate");
  })
  .catch(err => {
    loadingStatus.textContent = "‚ö†Ô∏è Gagal mengambil data";
    console.error(err);
  });

// --- Update Daftar File Terpilih ---
function updateSelectedList() {
  if (selectedFiles.size === 0) {
    fileTerpilihEl.innerHTML = "";
    return;
  }
  let html = `<div class='table-wrapper'><h3>üìå File Terpilih</h3>
  <table>
    <thead>
      <tr>
        <th class="file-name">Nama File</th>
        <th>REV</th>
        <th>Link</th>
        <th>Hapus</th>
      </tr>
    </thead>
    <tbody>`;
  selectedFiles.forEach((file, key) => {
    html += `<tr>
      <td class="file-name">${file.name}</td>
      <td>${file.revisi}</td>
      <td><a href="${file.url}" target="_blank">üìÑ Lihat</a></td>
      <td><button onclick="hapusDipilih('${key}')">‚ùå</button></td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  fileTerpilihEl.innerHTML = html;
}

// --- Hapus dari File Terpilih ---
function hapusDipilih(key) {
  selectedFiles.delete(key);
  updateSelectedList();
  cari(); // refresh checkbox
}

// --- Pilih/Unpilih File ---
function toggleSelection(checkbox) {
  const key = checkbox.getAttribute("data-key");
  const [name, revisi, url] = key.split("|");
  if (checkbox.checked) {
    selectedFiles.set(key, { name, revisi, url });
  } else {
    selectedFiles.delete(key);
  }
  updateSelectedList();
}

// --- Pilih Semua ---
function toggleAll(source) {
  const checkboxes = document.querySelectorAll("input[type='checkbox'].item-check");
  checkboxes.forEach(cb => {
    cb.checked = source.checked;
    cb.dispatchEvent(new Event('change'));
  });
}

// --- Fungsi Sorting ---
function sortTable(column) {
  if (sortState.column === column) {
    sortState.asc = !sortState.asc;
  } else {
    sortState.column = column;
    sortState.asc = true;
  }
  cari(); // Refresh tabel dengan urutan baru
}

// --- Fungsi Pencarian & Tampilkan Tabel ---
function cari() {
  const keyword = document.getElementById("keyword").value.trim().toLowerCase();
  if (!keyword) return;
  const hasil = semuaData.filter(item =>
    item.name.toLowerCase().includes(keyword)
  );
  const fileTerakhir = {};
  hasil.forEach(file => {
    const key = `${file.kode}-${file.kode_lanjutan}-${file.halaman}`;
    const revStr = String(file.revisi).trim();
    let revCompare = /^\d+$/.test(revStr) ? parseInt(revStr) : revStr.toUpperCase().charCodeAt(0);
    if (!fileTerakhir[key] || revCompare > fileTerakhir[key].revCompare) {
      fileTerakhir[key] = { ...file, revCompare };
    }
  });

  let dataRows = Object.values(fileTerakhir);

  // Sorting jika sortState ada
  if (sortState.column) {
    dataRows.sort((a, b) => {
      let aVal = a[sortState.column];
      let bVal = b[sortState.column];

      // Untuk REV, jika angka bandingkan sebagai angka
      if (sortState.column === "revisi") {
        let aNum = parseInt(aVal, 10);
        let bNum = parseInt(bVal, 10);
        if (!isNaN(aNum) && !isNaN(bNum)) {
          aVal = aNum; bVal = bNum;
        }
      }

      if (aVal < bVal) return sortState.asc ? -1 : 1;
      if (aVal > bVal) return sortState.asc ? 1 : -1;
      return 0;
    });
  }

  let html = `<div class='table-wrapper'><table>
    <thead>
      <tr>
        <th><input type='checkbox' onclick='toggleAll(this)'> All</th>
        <th class="file-name sortable" onclick="sortTable('name')">
          Nama File <span id="sort-name"></span>
        </th>
        <th class="sortable" onclick="sortTable('revisi')">
          REV <span id="sort-revisi"></span>
        </th>
        <th>Link PDF</th>
      </tr>
    </thead>
    <tbody>`;

  dataRows.forEach(file => {
    const fileKey = `${file.name}|${file.revisi}|${file.url}`;
    const isChecked = selectedFiles.has(fileKey) ? "checked" : "";
    html += `<tr>
      <td><input type='checkbox' class='item-check' data-key="${fileKey}" onchange="toggleSelection(this)" ${isChecked}></td>
      <td class="file-name">${file.name}</td>
      <td>${file.revisi}</td>
      <td><a href="${file.url}" target="_blank">üìÑ Buka File</a></td>
    </tr>`;
  });

  html += "</tbody></table></div>";
  hasilEl.innerHTML = html;
  exportArea.style.display = "block";
  loadingStatus.style.display = "none";
  updateSelectedList();

  // Update icon sort
  document.getElementById("sort-name").textContent =
    sortState.column === "name" ? (sortState.asc ? "‚ñ≤" : "‚ñº") : "";
  document.getElementById("sort-revisi").textContent =
    sortState.column === "revisi" ? (sortState.asc ? "‚ñ≤" : "‚ñº") : "";
}

// --- Export ke Excel ---
function exportToExcel() {
  if (selectedFiles.size === 0) {
    alert("‚ùó Pilih minimal satu file terlebih dahulu.");
    return;
  }
  const data = [["Nama File", "REV", "Link PDF"]];
  selectedFiles.forEach(file => {
    data.push([file.name, file.revisi, file.url]);
  });
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "File Terpilih");
  XLSX.writeFile(wb, "file_terpilih.xlsx");
}